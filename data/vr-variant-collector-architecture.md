# VR å˜ä½“æ”¶é›†å™¨ - æ¶æ„ä¸æµç¨‹å›¾è§£

**æ ‡ç­¾**ï¼š#unity #shader #architecture #shader-variants
**æ¥æº**ï¼šKTSAMA å®è·µç»éªŒ
**æ”¶å½•æ—¥æœŸ**ï¼š2026-02-08
**æ›´æ–°æ—¥æœŸ**ï¼š2025-12-12
**çŠ¶æ€**ï¼šğŸ“˜ æœ‰æ•ˆ
**å¯ä¿¡åº¦**ï¼šâ­â­â­â­ (é¡¹ç›®æ–‡æ¡£)

> **è¯´æ˜**ï¼šæœ¬æ–‡æ¡£åŒ…å« Mermaid å›¾è¡¨æºç ã€‚
> è¯·åœ¨ VS Code ä¸­ç‚¹å‡»å³ä¸Šè§’çš„ **"Open Preview to the Side"** (å¿«æ·é”® `Ctrl+K V`) æŸ¥çœ‹å›¾å½¢åŒ–æ¸²æŸ“æ•ˆæœã€‚

---

## 1. æ ¸å¿ƒæ‰§è¡Œæµç¨‹ (Execution Flow)

æ­¤æµç¨‹å›¾æè¿°äº† `VRVariantCollectorCore.RunCollection` çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸã€‚

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- **åŒæ–‡ä»¶æ”¶é›†**ï¼šNonVR æ–‡ä»¶ + VR æ–‡ä»¶ï¼Œåˆ†åˆ«æ”¶é›†ä¸åŒçš„å˜ä½“
- **å…¨å±€ VR å…³é”®å­—æ¿€æ´»**ï¼šé€šè¿‡ `VRGlobalKeywordManager` æ§åˆ¶ `STEREO_MULTIVIEW_ON`
- åŒæ­¥ç¼–è¯‘æ¨¡å¼ï¼ˆ`EditorSettings.asyncShaderCompilation = false`ï¼‰
- é›¾æ•ˆæ¨¡å¼å¤–å±‚å¾ªç¯æ¶æ„

```mermaid
flowchart TD
    %% æ ·å¼å®šä¹‰
    classDef startend fill:#f9f,stroke:#333,stroke-width:2px;
    classDef process fill:#e1f5fe,stroke:#0277bd,stroke-width:2px;
    classDef decision fill:#fff9c4,stroke:#fbc02d,stroke-width:2px;
    classDef error fill:#ffcdd2,stroke:#c62828,stroke-width:2px;
    classDef warmup fill:#ffe0b2,stroke:#e65100,stroke-width:2px;
    classDef critical fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px;
    classDef vr fill:#e1bee7,stroke:#7b1fa2,stroke-width:2px;

    Start(["å¼€å§‹"]):::startend --> GlobalSetup

    %% ============================================================
    %% å…¨å±€è®¾ç½®ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰
    %% ============================================================
    subgraph GlobalSetup ["å…¨å±€è®¾ç½® (Once)"]
        direction TB
        GS_Start("å¼€å§‹") --> GS_Async["ç¦ç”¨å¼‚æ­¥ç¼–è¯‘"]:::critical
        GS_Async --> GS_Iso["ç¯å¢ƒéš”ç¦»"]:::process
        GS_Iso --> GS_Mat["æ”¶é›†æè´¨åˆ—è¡¨"]:::process
        GS_Mat --> GS_Scene["åˆ›å»ºåœºæ™¯&ç›¸æœº"]:::process
    end

    GlobalSetup --> CheckWarmup

    %% ============================================================
    %% å…¨å±€é¢„çƒ­ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰
    %% ============================================================
    CheckWarmup{"é¢„çƒ­?"}:::decision
    CheckWarmup -- "å¦" --> NonVR_Start
    CheckWarmup -- "æ˜¯" --> GlobalWarmup
    
    subgraph GlobalWarmup ["å…¨å±€é¢„çƒ­ (Once)"]
        direction TB
        GW_NonVR["NonVR é¢„çƒ­æ¸²æŸ“"]:::warmup --> GW_VR["VR é¢„çƒ­æ¸²æŸ“"]:::vr
        GW_VR --> GW_Clear["æ¸…ç©ºå˜ä½“ç¼“å­˜"]:::warmup
    end
    
    GlobalWarmup --> NonVR_Start

    %% ============================================================
    %% ç¬¬ä¸€è½®ï¼šNonVR æ”¶é›†
    %% ============================================================
    subgraph NonVR_Collection ["ç¬¬ä¸€è½®: NonVR æ”¶é›†"]
        direction TB
        NonVR_Start("å¼€å§‹") --> NonVR_Disable["ç¦ç”¨ VR å…¨å±€å…³é”®å­—"]:::process
        NonVR_Disable --> NonVR_FogLoop{"é›¾æ•ˆæ¨¡å¼"}:::decision
        
        NonVR_FogLoop -- "ä¸‹ä¸€ä¸ª" --> NonVR_SetFog["è®¾ç½®é›¾æ•ˆ"]:::process
        NonVR_SetFog --> NonVR_Batch{"æè´¨æ‰¹æ¬¡"}:::decision
        
        NonVR_Batch -- "æœ‰" --> NonVR_Render["å®‰å…¨æ¸²æŸ“"]:::process
        NonVR_Render --> NonVR_Batch
        
        NonVR_Batch -- "å®Œæˆ" --> NonVR_FogLoop
        NonVR_FogLoop -- "å…¨éƒ¨å®Œæˆ" --> NonVR_Save["ä¿å­˜ SVC"]:::process
        NonVR_Save --> NonVR_Post["åå¤„ç†: ç§»é™¤VRå˜ä½“"]:::process
    end

    NonVR_Collection --> VR_Start

    %% ============================================================
    %% ç¬¬äºŒè½®ï¼šVR æ”¶é›†
    %% ============================================================
    subgraph VR_Collection ["ç¬¬äºŒè½®: VR æ”¶é›†"]
        direction TB
        VR_Start("å¼€å§‹") --> VR_Enable["å¯ç”¨ VR å…¨å±€å…³é”®å­—"]:::vr
        VR_Enable --> VR_FogLoop{"é›¾æ•ˆæ¨¡å¼"}:::decision
        
        VR_FogLoop -- "ä¸‹ä¸€ä¸ª" --> VR_SetFog["è®¾ç½®é›¾æ•ˆ"]:::vr
        VR_SetFog --> VR_Batch{"æè´¨æ‰¹æ¬¡"}:::decision
        
        VR_Batch -- "æœ‰" --> VR_Render["å®‰å…¨æ¸²æŸ“"]:::vr
        VR_Render --> VR_Batch
        
        VR_Batch -- "å®Œæˆ" --> VR_FogLoop
        VR_FogLoop -- "å…¨éƒ¨å®Œæˆ" --> VR_Save["ä¿å­˜ SVC"]:::vr
        VR_Save --> VR_Post["åå¤„ç†: ç§»é™¤éVRå˜ä½“"]:::vr
    end

    VR_Collection --> GlobalCleanup

    %% ============================================================
    %% å…¨å±€æ¸…ç†ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰
    %% ============================================================
    subgraph GlobalCleanup ["å…¨å±€æ¸…ç† (Once)"]
        direction TB
        GC_Disable["ç¦ç”¨ VR å…¨å±€å…³é”®å­—"]:::process --> GC_Restore["æ¢å¤å¼‚æ­¥ç¼–è¯‘"]:::critical
        GC_Restore --> GC_Dispose["é‡Šæ”¾ç¯å¢ƒéš”ç¦»"]:::process
        GC_Dispose --> GC_Select["é€‰ä¸­è¾“å‡ºæ–‡ä»¶"]:::process
    end

    GlobalCleanup --> End(["ç»“æŸ"]):::startend
```

---

## 2. åŒæ–‡ä»¶æ”¶é›†æ¶æ„è¯¦è§£

### 2.1 è¾“å‡ºæ–‡ä»¶è¯´æ˜

```
SavePath: Assets/ShaderVariants/GameShaderVariants.shadervariants

å®é™…è¾“å‡º:
â”œâ”€â”€ GameShaderVariants_NonVR.shadervariants   â† ä¸å« VR å…³é”®å­—çš„å˜ä½“ï¼ˆç”¨äºæ‰“åŒ…ä¿ç•™ Shaderï¼‰
â”œâ”€â”€ GameShaderVariants_NonVR.json             â† NonVR æ¸…å•
â”œâ”€â”€ GameShaderVariants_VR.shadervariants      â† å« VR å…³é”®å­—çš„å˜ä½“ï¼ˆç”¨äºè¿è¡Œæ—¶é¢„çƒ­ï¼‰
â””â”€â”€ GameShaderVariants_VR.json                â† VR æ¸…å•
```

### 2.2 åŒæ–‡ä»¶è®¾è®¡ç›®çš„

| æ–‡ä»¶ | ä¸»è¦ç”¨é€” | è¯´æ˜ |
|------|----------|------|
| **NonVR SVC** | æ‰“åŒ…æ—¶ä¿ç•™ Shader | ç¡®ä¿ç›¸å…³ Shader ä¸ä¼šå› ä¸º"æ²¡æœ‰è¢«ä½¿ç”¨çš„å˜ä½“"è€Œè¢«å‰”é™¤ |
| **VR SVC** | è¿è¡Œæ—¶é¢„çƒ­ | åªåŒ…å« VR å˜ä½“ï¼Œå‡å°‘é¢„çƒ­æ—¶é—´ï¼ˆçº¦èŠ‚çœä¸€åŠï¼‰ |

### 2.3 VR å…³é”®å­—è¯´æ˜

| å¹³å° | å…¨å±€å…³é”®å­— | è¯´æ˜ |
|------|-----------|------|
| Quest (Multiview) | `STEREO_MULTIVIEW_ON` | Meta Quest çš„å¤šè§†å›¾æ¸²æŸ“ |
| PCVR (Instancing) | `STEREO_INSTANCING_ON` | PC VR çš„å®ä¾‹åŒ–ç«‹ä½“æ¸²æŸ“ |

**æŠ€æœ¯ç»†èŠ‚**ï¼š
- è¿™äº›æ˜¯ Unity å¼•æ“å†…ç½®çš„**å…¨å±€å…³é”®å­—**ï¼Œæ— æ³•é€šè¿‡æè´¨å±æ€§è®¾ç½®
- åªæœ‰å½“ XR ç³»ç»Ÿæ¿€æ´»æ—¶ï¼ŒUnity æ‰ä¼šåœ¨æ¸²æŸ“æ—¶å¯ç”¨è¿™äº›å…³é”®å­—
- æœ¬å·¥å…·é€šè¿‡ `VRGlobalKeywordManager.EnableVRKeyword()` åœ¨ç¼–è¾‘å™¨ä¸­æ¨¡æ‹Ÿæ¿€æ´»

---

## 3. ç±»ç»“æ„ä¸å…³ç³» (Class Architecture)

### 3.1 è°ƒç”¨å±‚çº§å›¾

```mermaid
flowchart LR
    subgraph L1["UI å±‚"]
        A[VRVariantCollectorWindow]
        B[VRVariantCollectorSettings]
    end
    
    subgraph L2["æ ¸å¿ƒå±‚"]
        C[VRVariantCollectorCore]
    end
    
    subgraph L3["è¾…åŠ©å±‚"]
        D[VRGlobalKeywordManager]
        E[EditorEnvironmentIsolator]
        F[VRVariantPostProcessor]
        G[ShaderVariantCollectionHelper]
    end
    
    A -->|æ‰“å¼€| B
    B -->|è¿è¡Œ| C
    C --> D
    C --> E
    C --> F
    C --> G
    
    style L1 fill:#e3f2fd,stroke:#1565c0
    style L2 fill:#fff3e0,stroke:#ef6c00
    style L3 fill:#f3e5f5,stroke:#7b1fa2
```

### 3.2 ç±»èŒè´£è¯´æ˜

| å±‚çº§ | ç±»å | èŒè´£ |
|:----:|------|------|
| **UI** | `VRVariantCollectorWindow` | èœå•å…¥å£ï¼Œæ‰“å¼€å·¥å…·çª—å£ |
| **UI** | `VRVariantCollectorSettings` | Odin é¢æ¿ï¼Œç”¨æˆ·é…ç½®ä¸æ“ä½œæŒ‰é’® |
| **æ ¸å¿ƒ** | `VRVariantCollectorCore` | æ”¶é›†æµç¨‹æ§åˆ¶ï¼Œåç¨‹é©±åŠ¨ |
| **æ ¸å¿ƒ** | `VRVariantCollectorConfig` | é…ç½®æ•°æ®å®¹å™¨ï¼ˆç”± Settings ç”Ÿæˆï¼‰ |
| **æ ¸å¿ƒ** | `CollectionContext` | è¿è¡Œæ—¶çŠ¶æ€ä¸Šä¸‹æ–‡ï¼ˆCore å†…éƒ¨ç»´æŠ¤ï¼‰ |
| **è¾…åŠ©** | `VRGlobalKeywordManager` | VR å…¨å±€å…³é”®å­—å¼€å…³ï¼ˆé™æ€ç±»ï¼‰ |
| **è¾…åŠ©** | `EditorEnvironmentIsolator` | ç¼–è¾‘å™¨çª—å£éš”ç¦»ï¼Œé˜²æ­¢æ±¡æŸ“ |
| **è¾…åŠ©** | `VRVariantPostProcessor` | SVC åå¤„ç†ï¼šè¿‡æ»¤ VR/NonVR å˜ä½“ |
| **è¾…åŠ©** | `ShaderVariantCollectionHelper` | åº•å±‚ SVC è¯»å†™æ“ä½œï¼ˆé™æ€ç±»ï¼‰ |

### 3.3 æ ¸å¿ƒç±»è¯¦ç»†ç»“æ„

```
VRVariantCollectorCore
â”œâ”€â”€ å­—æ®µ
â”‚   â”œâ”€â”€ _context : CollectionContext      // è¿è¡Œæ—¶çŠ¶æ€
â”‚   â””â”€â”€ _cachedMaterialPaths : List<string>  // æè´¨è·¯å¾„ç¼“å­˜
â”‚
â”œâ”€â”€ å…¬å¼€æ–¹æ³•
â”‚   â””â”€â”€ RunCollection()                   // ä¸»å…¥å£ï¼Œè¿”å› IEnumerator
â”‚
â””â”€â”€ ç§æœ‰æ–¹æ³•
    â”œâ”€â”€ DoGlobalWarmup()                  // å…¨å±€é¢„çƒ­ï¼ˆNonVR + VRï¼‰
    â”œâ”€â”€ DoVariantCollection()             // å˜ä½“æ”¶é›†ï¼ˆå•è½®ï¼‰
    â”œâ”€â”€ ProcessBatchSingleFogMode()       // æ‰¹æ¬¡å¤„ç†
    â”œâ”€â”€ ExecuteSingleFogRenderSafe()      // å®‰å…¨æ¸²æŸ“ï¼ˆå¸¦å¼‚å¸¸ä¿æŠ¤ï¼‰
    â””â”€â”€ IsShaderValid()                   // Shader æœ‰æ•ˆæ€§æ£€æŸ¥
```

```
VRVariantPostProcessor
â”œâ”€â”€ å…¬å¼€æ–¹æ³•
â”‚   â””â”€â”€ ProcessWithoutVRInject()          // åå¤„ç†å…¥å£ï¼ˆä¸æ³¨å…¥ VR å®ï¼‰
â”‚
â””â”€â”€ ç§æœ‰æ–¹æ³•
    â”œâ”€â”€ RemoveVRKeywordVariants()         // ç§»é™¤ VR å…³é”®å­—å˜ä½“ï¼ˆNonVR æ–‡ä»¶ç”¨ï¼‰
    â”œâ”€â”€ RemoveNonVRVariantsFromVRFile()   // ç§»é™¤é VR å˜ä½“ï¼ˆVR æ–‡ä»¶ç”¨ï¼‰
    â”œâ”€â”€ RemoveUnwantedShadersAndVariants() // ç§»é™¤é»‘åå• Shader
    â””â”€â”€ RemoveInvalidVariants()           // ç§»é™¤æ— æ•ˆå˜ä½“
```

---

## 4. å·¥å…·ç•Œé¢ä¸åŠŸèƒ½è¯´æ˜

### 4.1 æ“ä½œæ  (Operations)

| æŒ‰é’®åç§° | åŠŸèƒ½æè¿° |
|----------|----------|
| **å¼€å§‹æ”¶é›†** | æ‰§è¡ŒåŒæ–‡ä»¶æ”¶é›†ï¼Œè¾“å‡º NonVR + VR ä¸¤ä¸ª SVC æ–‡ä»¶ |
| **ç¨³å®šæ€§æµ‹è¯•** | è¿ç»­æ‰§è¡Œå¤šæ¬¡æ”¶é›†ï¼ŒéªŒè¯å˜ä½“æ”¶é›†çš„ç¡®å®šæ€§ |
| **åœæ­¢** | ä¸­æ–­ä»»åŠ¡ï¼Œè‡ªåŠ¨æ¸…ç†å¹¶æ¢å¤ç¯å¢ƒ |

### 4.2 æ”¶é›†é…ç½®

| é…ç½®é¡¹ | è¯´æ˜ |
|--------|------|
| **æ”¶é›†æ¨¡å¼** | `YooAssetPackage`ï¼ˆæ¨èï¼‰æˆ– `FolderDirect` |
| **YooAsset åŒ…å** | è¦åˆ†æçš„èµ„æºåŒ…åç§° |
| **ä¿å­˜è·¯å¾„** | åŸºç¡€è·¯å¾„ï¼Œå®é™…ä¼šç”Ÿæˆ `_NonVR` å’Œ `_VR` ä¸¤ä¸ªæ–‡ä»¶ |
| **ç›®æ ‡å¹³å°** | Quest (Multiview) æˆ– PCVR (Instancing) |

### 4.3 æ”¶é›†è§„åˆ™

| é…ç½®é¡¹ | è¯´æ˜ |
|--------|------|
| **æ¯å¸§å¤„ç†æè´¨æ•°** | å»ºè®® 50-100ï¼Œè¿‡å¤§å¯èƒ½å¯¼è‡´å¡é¡¿ |
| **æ”¶é›†é›¾æ•ˆæ¨¡å¼** | å¤šé€‰ï¼šFogOff / Linear / Exp / Exp2 |
| **å¯ç”¨ç¯å¢ƒéš”ç¦»** | **å¼ºçƒˆå»ºè®®å¼€å¯**ï¼Œé˜²æ­¢ç¼–è¾‘å™¨æ±¡æŸ“ |
| **å¯ç”¨é¢„çƒ­é˜¶æ®µ** | é¦–æ¬¡æ”¶é›†å»ºè®®å¼€å¯ï¼Œé¿å…ä¸­é—´å˜ä½“ |
| **å¤ç”¨æè´¨ç´¢å¼•** | ç¨³å®šæ€§æµ‹è¯•æ—¶è‡ªåŠ¨å¯ç”¨ï¼ŒåŠ é€Ÿåç»­è¿­ä»£ |

### 4.4 åå¤„ç†è®¾ç½®

| é…ç½®é¡¹ | è¯´æ˜ |
|--------|------|
| **é¢å¤–å…‰å˜ä½“å¤„ç†** | å¤„ç† `_ADDITIONAL_LIGHTS` å®çš„ç­–ç•¥ |
| **é»‘åå•è·¯å¾„** | è·³è¿‡åŒ¹é…çš„æè´¨/Shader |

---

## 5. åå¤„ç†æµç¨‹è¯¦è§£

### 5.1 NonVR æ–‡ä»¶åå¤„ç†

```mermaid
flowchart LR
    A[åŸå§‹ SVC] --> B[ç§»é™¤æ— æ•ˆå˜ä½“]
    B --> C[ç§»é™¤é»‘åå• Shader]
    C --> D["ç§»é™¤ VR å…³é”®å­—å˜ä½“"]
    D --> E[é¢å¤–å…‰å¤„ç†]
    E --> F[ç”Ÿæˆ JSON]
```

**å…³é”®æ­¥éª¤**ï¼š`RemoveVRKeywordVariants()` ç§»é™¤æ‰€æœ‰åŒ…å« `STEREO_MULTIVIEW_ON` æˆ– `STEREO_INSTANCING_ON` çš„å˜ä½“ã€‚

### 5.2 VR æ–‡ä»¶åå¤„ç†

```mermaid
flowchart LR
    A[åŸå§‹ SVC] --> B[ç§»é™¤æ— æ•ˆå˜ä½“]
    B --> C[ç§»é™¤é»‘åå• Shader]
    C --> D["ç§»é™¤é VR å˜ä½“*"]
    D --> E[é¢å¤–å…‰å¤„ç†]
    E --> F[ç”Ÿæˆ JSON]
```

**å…³é”®æ­¥éª¤**ï¼š`RemoveNonVRVariantsFromVRFile()` ç§»é™¤ä¸å« VR å…³é”®å­—çš„å˜ä½“ï¼Œ**ä½†ä¿ç•™**ï¼š
- `ShadowCaster` Passï¼ˆé˜´å½±ä¸éœ€è¦ VR å®ï¼‰
- `DepthOnly` Passï¼ˆæ·±åº¦ä¸éœ€è¦ VR å®ï¼‰
- `Meta` Passï¼ˆçƒ˜ç„™ä¸éœ€è¦ VR å®ï¼‰

---

## 6. å´©æºƒä¿æŠ¤æœºåˆ¶

### 6.1 Shader æœ‰æ•ˆæ€§æ£€æŸ¥

```csharp
private bool IsShaderValid(Shader shader)
{
    if (shader == null) return false;
    if (!shader.isSupported) return false;
    if (shaderName.Contains("Error")) return false;
    if (shaderName.Contains("Hidden/InternalErrorShader")) return false;
    
    // å·²çŸ¥æœ‰é—®é¢˜çš„ Shaderï¼ˆå¦‚ Oculus MRCameraï¼‰
    if (shaderName.StartsWith("Oculus/") && shaderName.Contains("MRCamera"))
        return false;
    
    return true;
}
```

### 6.2 å®‰å…¨æ¸²æŸ“æ–¹æ³•

```csharp
private IEnumerator ExecuteSingleFogRenderSafe()
{
    for (int i = 0; i < 3; i++)
    {
        bool needRecovery = false;
        try
        {
            _context.RenderCamera.Render();
        }
        catch (Exception e)
        {
            Debug.LogWarning($"æ¸²æŸ“å¼‚å¸¸(å·²æ¢å¤): {e.Message}");
            needRecovery = true;
        }
        
        if (needRecovery)
            System.GC.Collect();
        
        yield return null;
    }
}
```

### 6.3 æ‰¹æ¬¡é—´ GC

æ¯ 5 ä¸ªæ‰¹æ¬¡å¼ºåˆ¶æ‰§è¡Œä¸€æ¬¡ `GC.Collect()`ï¼Œé™ä½å†…å­˜å‹åŠ›ã€‚

---

## 7. è¾…åŠ©å·¥å…·

| å·¥å…· | å…¥å£ | åŠŸèƒ½ |
|------|------|------|
| **å˜ä½“å¯¹æ¯”å·¥å…·** | `KT_Tools/Shader/å˜ä½“å¯¹æ¯”å·¥å…·` | å¯¹æ¯”ä¸¤ä¸ª SVC æ–‡ä»¶çš„å·®å¼‚ |
| **æè´¨å®ä¾‹åœºæ™¯ç”Ÿæˆå™¨** | `KT_Tools/Shader/æè´¨å®ä¾‹åœºæ™¯ç”Ÿæˆå™¨` | ç”Ÿæˆæè´¨æµ‹è¯•åœºæ™¯ |
| **æŠ¥å‘Šçª—å£** | ä¸»ç•Œé¢ â†’ "æ‰“å¼€æŠ¥å‘Š" | æŸ¥çœ‹ç¨³å®šæ€§æµ‹è¯•æ—¥å¿— |

---

## 8. å¼€å‘è¸©å‘ä¸æ³¨æ„äº‹é¡¹ (Pitfalls & Best Practices)

è®°å½•äº†åœ¨å·¥å…·å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„å…³é”®æŠ€æœ¯éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆï¼Œä¾›åç»­ç»´æŠ¤å‚è€ƒã€‚

### 8.1 åç¨‹åµŒå¥—ä¸æ‰§è¡Œæµ (Coroutine Execution)

- **é—®é¢˜**ï¼šåœ¨ `EditorApplication.update` ä¸­é©±åŠ¨åç¨‹æ—¶ï¼Œç›´æ¥ `yield return` å¦ä¸€ä¸ª `IEnumerator`ï¼ˆå¦‚ `yield return BeforeCollection()`ï¼‰ä¸ä¼šè‡ªåŠ¨ç­‰å¾…å­åç¨‹å®Œæˆï¼Œå¯¼è‡´ä¸»æµç¨‹ç¬é—´è·‘å®Œï¼Œè·³è¿‡äº†æ‰€æœ‰å­æ­¥éª¤ã€‚
- **è§£å†³**ï¼šå¿…é¡»æ‰‹åŠ¨å±•å¼€å­åç¨‹çš„è¿­ä»£ã€‚
    ```csharp
    // é”™è¯¯å†™æ³•
    yield return BeforeCollection(); 
    
    // æ­£ç¡®å†™æ³•
    var routine = BeforeCollection();
    while (routine.MoveNext()) yield return routine.Current;
    ```

### 8.2 ç¼–è¾‘å™¨ç¯å¢ƒæ±¡æŸ“ (Editor Pollution)

- **é—®é¢˜**ï¼šæ”¶é›†åˆ°çš„å˜ä½“ä¸­å‡ºç°å¤§é‡åªæœ‰ `STEREO_MULTIVIEW_ON` å®çš„å¥‡æ€ªå˜ä½“ï¼Œæˆ–è€…åŒ…å«ç¼–è¾‘å™¨ä¸“ç”¨çš„ Passã€‚
- **åŸå› **ï¼šUnity ç¼–è¾‘å™¨çš„ Inspector çª—å£ã€Scene è§†å›¾ã€Project é¢„è§ˆçª—å£åœ¨åå°æ¸²æŸ“æè´¨æ—¶ï¼Œä¼šæ ¹æ®å½“å‰ç¼–è¾‘å™¨çŠ¶æ€ï¼ˆå¦‚é€‰ä¸­é¡¹ã€å…‰ç…§è®¾ç½®ï¼‰è§¦å‘ Shader ç¼–è¯‘ã€‚è¿™äº›"åå°æ¸²æŸ“"äº§ç”Ÿçš„å˜ä½“ä¼šè¢« `ShaderVariantCollection` é”™è¯¯åœ°æ•è·ã€‚
- **è§£å†³**ï¼š
    1. **ç¯å¢ƒéš”ç¦»**ï¼šå¼€å‘ `EditorEnvironmentIsolator`ï¼Œåœ¨æ”¶é›†å¼€å§‹å‰å¼ºåˆ¶å…³é—­ Inspectorã€SceneView ç­‰æ‰€æœ‰å¹²æ‰°çª—å£ï¼Œåªä¿ç•™ Game è§†å›¾ã€‚
    2. **èšç„¦ Game è§†å›¾**ï¼šå¼ºåˆ¶ Focus Game Windowï¼Œç¡®ä¿æ¸²æŸ“é‡å¿ƒåœ¨æ”¶é›†ç›¸æœºä¸Šã€‚
    3. **åå¤„ç†è¿‡æ»¤**ï¼šå¢åŠ  `DetectSuspiciousVROnlyVariants` æ£€æµ‹é€»è¾‘ï¼Œæ ‡è®°å¯ç–‘å˜ä½“ã€‚

### 8.3 Shader ç¼–è¯‘æ—¶æœº (Compilation Timing)

- **é—®é¢˜**ï¼šæè´¨æ¸²æŸ“äº†ï¼Œä½†å˜ä½“æ²¡æ”¶é›†åˆ°ã€‚
- **åŸå› **ï¼šé»˜è®¤æƒ…å†µä¸‹ `Camera.Render()` æäº¤åï¼ŒShader ç¼–è¯‘æ˜¯å¼‚æ­¥çš„ã€‚å¦‚æœç«‹å³è¿›è¡Œä¸‹ä¸€å¸§ï¼Œç¼–è¯‘å¯èƒ½è¿˜æ²¡å®Œæˆï¼Œå¯¼è‡´å˜ä½“ä¸¢å¤±ã€‚
- **è§£å†³**ï¼š
    1. **ã€å…³é”®ã€‘ç¦ç”¨å¼‚æ­¥ç¼–è¯‘**ï¼šåœ¨æ”¶é›†å¼€å§‹æ—¶è®¾ç½® `EditorSettings.asyncShaderCompilation = false`ï¼Œå¼ºåˆ¶åŒæ­¥ç¼–è¯‘ã€‚
    2. åŒæ­¥ç¼–è¯‘æ¨¡å¼ä¸‹ï¼Œ`Camera.Render()` ä¼šé˜»å¡ç›´åˆ° Shader ç¼–è¯‘å®Œæˆï¼Œç¡®ä¿å˜ä½“è¢«æ­£ç¡®è®°å½•ã€‚
    3. æ”¶é›†ç»“æŸåæ¢å¤åŸè®¾ç½®ã€‚
- **æ³¨æ„**ï¼šæ—§ç‰ˆæœ¬ä½¿ç”¨ `ShaderUtil.allowAsyncCompilation` å’Œ `ShaderUtil.anythingCompiling` æ£€æµ‹ï¼Œä½†åœ¨ Unity 2022+ ä¸­ `EditorSettings.asyncShaderCompilation` æ˜¯æ›´å¯é çš„æ–¹æ¡ˆã€‚

### 8.4 é¢å¤–å…‰å®ä¸ä¸€è‡´ (_ADDITIONAL_LIGHTS)

- **éªŒè¯ç¯å¢ƒ**ï¼šUnity 2022.3.39f1 + URP 14.0.11
- **é—®é¢˜**ï¼šURP ç®¡çº¿è®¾ç½®ä¸­è‹¥å¼€å¯äº†é¢å¤–å…‰ï¼ˆAdditional Lightsï¼‰ï¼Œå³ä½¿æ”¶é›†åœºæ™¯ä¸­æ²¡æœ‰ä»»ä½•å…‰æºï¼ŒUnity æ”¶é›†åˆ°çš„å˜ä½“ä¹Ÿä¼šè¢«å¼ºåˆ¶åŠ ä¸Š `_ADDITIONAL_LIGHTS` å®ã€‚
- **åæœ**ï¼šçœŸæœºè¿è¡Œæ—¶ï¼Œå¦‚æœåœºæ™¯ç¡®å®æ²¡æœ‰å®æ—¶å…‰ï¼ˆä¾‹å¦‚å…¨çƒ˜ç„™åœºæ™¯ï¼‰ï¼Œå¼•æ“è¯·æ±‚çš„æ˜¯**ä¸å¸¦**è¯¥å®çš„å˜ä½“ã€‚å¯¼è‡´"æ”¶é›†äº†å¸¦å®çš„ï¼Œè¿è¡Œæ—¶è¦ä¸å¸¦å®çš„"ï¼Œå˜ä½“å‘½ä¸­å¤±è´¥ï¼Œæ”¶é›†å·¥ä½œå‡ ä¹ç™½è´¹ã€‚
- **è§£å†³**ï¼šåœ¨åå¤„ç†é˜¶æ®µ (`VRVariantPostProcessor`) å¢åŠ é€»è¾‘ï¼Œä¸“é—¨å¤„ç† `_ADDITIONAL_LIGHTS` å®ã€‚æ”¯æŒ"ä»…ç§»é™¤"æˆ–"ç”Ÿæˆæ— å…‰ç‰ˆæœ¬"ä¸¤ç§ç­–ç•¥ï¼Œç¡®ä¿å˜ä½“è¦†ç›–çœŸæœºæƒ…å†µã€‚

### 8.5 é›¾æ•ˆå˜ä½“é—æ¼ (Fog Variants)

- **é—®é¢˜**ï¼šåœºæ™¯ä¸­å¼€å¯äº†é›¾ï¼Œä½†æ”¶é›†åˆ°çš„å˜ä½“ä¸åŒ…å«é›¾æ•ˆå®ã€‚
- **åŸå› **ï¼šUnity çš„ `ShaderVariantCollection` åªæœ‰åœ¨æ¸²æŸ“æ—¶å®é™…ç”¨åˆ°äº†é›¾æ•ˆï¼ˆä¸” `RenderSettings.fog = true`ï¼‰ï¼Œæ‰ä¼šè®°å½•ç›¸å…³å˜ä½“ã€‚
- **è§£å†³**ï¼šåœ¨æ¸²æŸ“å¾ªç¯ä¸­æ˜¾å¼éå†é›¾æ•ˆæ¨¡å¼ (`Linear`, `Exp`, `Exp2`)ï¼Œæ¯æ¬¡åˆ‡æ¢æ¨¡å¼åé‡æ–°æ¸²æŸ“ä¸€éã€‚

### 8.6 é›¾æ•ˆå¾ªç¯æ¶æ„é‡æ„ (Fog Loop Architecture)

- **é—®é¢˜**ï¼šæ—©æœŸç‰ˆæœ¬åœ¨æ¯ä¸ªæ‰¹æ¬¡å†…éƒ¨åˆ‡æ¢é›¾æ•ˆæ¨¡å¼ï¼ˆ`Batch1: [FogOffâ†’Linearâ†’Exp2] â†’ Batch2: [FogOffâ†’Linearâ†’Exp2]`ï¼‰ï¼Œå¯¼è‡´æ”¶é›†ç»“æœä¸ç¨³å®šã€‚
- **åŸå› **ï¼šé¢‘ç¹åˆ‡æ¢é›¾æ•ˆæ¨¡å¼å¯èƒ½å¯¼è‡´çŠ¶æ€ç«æ€ï¼Œç‰¹åˆ«æ˜¯åœ¨å¼‚æ­¥ç¼–è¯‘ç¯å¢ƒä¸‹ã€‚
- **è§£å†³**ï¼šå°†é›¾æ•ˆæ¨¡å¼å¾ªç¯**æå‡åˆ°æœ€å¤–å±‚**ï¼Œæ¯ä¸ªé›¾æ•ˆæ¨¡å¼å®Œæ•´éå†æ‰€æœ‰æè´¨ï¼š
    ```
    FogOff:  [Batch1 â†’ Batch2 â†’ ...å…¨éƒ¨æè´¨] â†’ 
    Linear:  [Batch1 â†’ Batch2 â†’ ...å…¨éƒ¨æè´¨] â†’ 
    Exp2:    [Batch1 â†’ Batch2 â†’ ...å…¨éƒ¨æè´¨]
    ```
- **ä¼˜ç‚¹**ï¼š
    - æ¯ä¸ªé›¾æ•ˆæ¨¡å¼çš„çŠ¶æ€ç¨³å®šï¼Œä¸ä¼šé¢‘ç¹åˆ‡æ¢
    - é…åˆåŒæ­¥ç¼–è¯‘ï¼Œç¡®ä¿æ”¶é›†ç»“æœå®Œå…¨ä¸€è‡´
    - ä¾¿äº GC æ¸…ç†ï¼Œæ¯ä¸ªé›¾æ•ˆæ¨¡å¼å¼€å§‹å‰æ‰§è¡Œä¸€æ¬¡ `GC.Collect()`

### 8.7 é»˜è®¤ç¯å¢ƒæ±¡æŸ“ (Default Environment Pollution)

- **é—®é¢˜**ï¼šå³ä½¿æ²¡æœ‰é…ç½®æ”¶é›†æ— é›¾å˜ä½“ï¼Œæ”¶é›†ç»“æœä¸­ä»å¶å°”å‡ºç°æ— é›¾å˜ä½“ã€‚
- **åŸå› **ï¼šåœ¨åˆ›å»ºæ¸²æŸ“å¯¹è±¡åï¼Œä»£ç æ‰§è¡Œäº† `yield return null`ã€‚æ­¤æ—¶ Unity ä¼šè§¦å‘ä¸€æ¬¡è‡ªåŠ¨ Repaintã€‚ç”±äºæ–°åœºæ™¯é»˜è®¤ `RenderSettings.fog = false`ï¼Œè¿™æ¬¡è‡ªåŠ¨æ¸²æŸ“å¯¼è‡´æ— é›¾å˜ä½“è¢«é”™è¯¯è®°å½•ã€‚
- **è§£å†³**ï¼š
    1. é‡‡ç”¨é›¾æ•ˆå¤–å±‚æ¶æ„ï¼Œåœ¨è®¾ç½®é›¾æ•ˆæ¨¡å¼åæ‰å¼€å§‹æè´¨æ¸²æŸ“ã€‚
    2. ç®€åŒ–æµç¨‹ï¼Œå‡å°‘ä¸å¿…è¦çš„ `yield return null`ï¼Œé™ä½æ„å¤–æ¸²æŸ“çš„æœºä¼šã€‚

### 8.8 å¼‚å¸¸æµç¨‹ä¸‹çš„ UI å¡æ­» (UI Freeze on Error)

- **é—®é¢˜**ï¼šå¦‚æœæ”¶é›†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼ˆå¦‚æœªæ‰¾åˆ°æè´¨ï¼‰ï¼Œä»£ç ç›´æ¥ `yield break` é€€å‡ºï¼Œå¯¼è‡´ `EditorEnvironmentIsolator.Dispose()` æœªè¢«æ‰§è¡Œï¼Œç¼–è¾‘å™¨ç•Œé¢ä¿æŒé”å®šçŠ¶æ€ã€‚
- **è§£å†³**ï¼šåœ¨ `RunCollection` çš„é”™è¯¯å¤„ç†åˆ†æ”¯ä¸­ï¼Œæ˜¾å¼è°ƒç”¨ `Cleanup()` å’Œ `DisposeEnvironmentIsolator()`ï¼Œç¡®ä¿æ— è®ºæˆåŠŸå¤±è´¥éƒ½èƒ½æ¢å¤ç¼–è¾‘å™¨å¸ƒå±€ã€‚

### 8.9 é¦–æ¬¡æ‰“å¼€é¡¹ç›®æ”¶é›†åˆ°ä¸­é—´å˜ä½“ (Intermediate Variants on Cold Start)

- **é—®é¢˜**ï¼šé¦–æ¬¡æ‰“å¼€é¡¹ç›®ï¼ˆæ²¡æœ‰ Shader ç¼“å­˜ï¼‰æ—¶è¿›è¡Œå˜ä½“æ”¶é›†ï¼Œä¼šæ”¶é›†åˆ°ä¸€äº›"ä¸­é—´å˜ä½“"â€”â€”å³ Shader ç¼–è¯‘è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸´æ—¶å˜ä½“ï¼Œè€Œéæœ€ç»ˆç¨³å®šçš„å˜ä½“ã€‚
- **åŸå› **ï¼šUnity çš„ Shader ç¼–è¯‘æ˜¯æ¸è¿›å¼çš„ã€‚å½“æ²¡æœ‰ç¼“å­˜æ—¶ï¼Œé¦–æ¬¡æ¸²æŸ“ä¼šè§¦å‘å¤§é‡ Shader ç¼–è¯‘ï¼Œç¼–è¯‘è¿‡ç¨‹ä¸­å¯èƒ½äº§ç”Ÿä¸€äº›ä¸´æ—¶çš„å˜ä½“ç»„åˆï¼Œè¿™äº›ç»„åˆä¼šè¢« `ShaderVariantCollection` é”™è¯¯åœ°è®°å½•ä¸‹æ¥ã€‚
- **è§£å†³**ï¼šå¼•å…¥"é¢„çƒ­é˜¶æ®µ"ï¼ˆWarmup Phaseï¼‰ï¼š
    1. **é¢„çƒ­æ¸²æŸ“**ï¼šå…ˆèµ°ä¸€éå®Œæ•´çš„æ¸²æŸ“æµç¨‹ï¼ˆåŒ…æ‹¬æ‰€æœ‰é›¾æ•ˆæ¨¡å¼ï¼‰ï¼Œç›®çš„æ˜¯è§¦å‘æ‰€æœ‰ Shader çš„ç¼–è¯‘ï¼Œä½†ä¸å…³å¿ƒæ­¤æ—¶æ”¶é›†åˆ°çš„å˜ä½“ã€‚
    2. **ç­‰å¾…ç¼–è¯‘å®Œæˆ**ï¼šç¡®ä¿æ‰€æœ‰ Shader éƒ½ç¼–è¯‘å®Œæ¯•ï¼Œè¿›å…¥ç¨³å®šçŠ¶æ€ã€‚
    3. **æ¸…ç©ºå˜ä½“ç¼“å­˜**ï¼šè°ƒç”¨ `ShaderVariantCollectionHelper.ClearCurrentShaderVariantCollection()` æ¸…ç©ºé¢„çƒ­é˜¶æ®µæ”¶é›†åˆ°çš„æ‰€æœ‰"ä¸­é—´å˜ä½“"ã€‚
    4. **æ­£å¼æ”¶é›†**ï¼šé‡ç½®å¤„ç†è®¡æ•°ï¼Œå¼€å§‹æ­£å¼çš„å˜ä½“æ”¶é›†æµç¨‹ã€‚æ­¤æ—¶æ‰€æœ‰ Shader éƒ½å·²ç¼–è¯‘å®Œæˆï¼Œæ”¶é›†åˆ°çš„éƒ½æ˜¯ç¨³å®šçš„æœ€ç»ˆå˜ä½“ã€‚
- **ç¨³å®šæ€§æµ‹è¯•ç‰¹æ®Šå¤„ç†**ï¼šç¨³å®šæ€§æµ‹è¯•æ—¶ï¼Œåªåœ¨ç¬¬ä¸€æ¬¡è¿­ä»£æ‰§è¡Œé¢„çƒ­ï¼Œåç»­è¿­ä»£ç›´æ¥å¤ç”¨å·²ç¼–è¯‘çš„ Shaderï¼Œæ— éœ€é‡å¤é¢„çƒ­ã€‚
- **ä½¿ç”¨å»ºè®®**ï¼šåœ¨ä»¥ä¸‹æƒ…å†µå»ºè®®å¼€å¯é¢„çƒ­ï¼š
    - é¦–æ¬¡æ‰“å¼€é¡¹ç›®
    - æ¸…ç†è¿‡ Library ç¼“å­˜
    - å¤§è§„æ¨¡ä¿®æ”¹ Shader å

### 8.10 åªä¿ç•™ VR å˜ä½“å¯¼è‡´ AB æ‰“åŒ…å‰”é™¤ (VR-Only SVC Causes AB Stripping) â­

- **é—®é¢˜**ï¼šå¦‚æœ SVC æ–‡ä»¶ä¸­åªä¿ç•™ VR å˜ä½“ï¼Œæ‰“ AB åŒ…æ—¶ Unity ä¼šå°†è¿™äº›å˜ä½“ç­›é€‰ä¸º"ä¸å¯ç”¨"æˆ–"æ²¡æœ‰è¢«ä½¿ç”¨"ï¼Œä»è€Œè¢«å‰”é™¤ã€‚å®é™…è¿è¡Œæ—¶ä¼šå‡ºç°å˜ä½“ä¸¢å¤±çš„ `shader variant not found` ç°è±¡ã€‚
- **åŸå› **ï¼šUnity æ‰“åŒ…æ—¶ä¼šæ£€æŸ¥ SVC ä¸­çš„å˜ä½“æ˜¯å¦ä¸å½“å‰å¹³å°/æ¸²æŸ“è®¾ç½®åŒ¹é…ã€‚çº¯ VR å˜ä½“ï¼ˆå¸¦ `STEREO_MULTIVIEW_ON`ï¼‰åœ¨é XR æ¿€æ´»çš„ç¼–è¾‘å™¨ç¯å¢ƒä¸‹è¢«è®¤ä¸º"ä¸å¯ç”¨"ã€‚
- **è§£å†³**ï¼šé‡‡ç”¨**åŒæ–‡ä»¶ç­–ç•¥**ï¼š
    - **NonVR SVC**ï¼šç”¨äºæ‰“åŒ…ï¼Œç¡®ä¿ Shader ä¸è¢«å‰”é™¤
    - **VR SVC**ï¼šç”¨äºè¿è¡Œæ—¶é¢„çƒ­ï¼ŒåªåŒ…å« VR å˜ä½“
- **æ³¨æ„**ï¼šè¿™ä¼šå¯¼è‡´åŒ…ä½“ç•¥å¾®å¢å¤§ï¼ˆçº¦ 20MBï¼‰ï¼Œå¦‚æœ‰å¿…è¦å¯é€šè¿‡ `IPreprocessShaders` åœ¨æ‰“åŒ…æ—¶å‰”é™¤é VR å˜ä½“ã€‚

### 8.11 å¼‚æ­¥ç¼–è¯‘äº§ç”Ÿä¸­é—´å˜ä½“ (Async Compilation Produces Intermediate Variants) â­

- **é—®é¢˜**ï¼šå¼‚æ­¥ç¼–è¯‘ Shader æ¨¡å¼ä¸‹ï¼Œåœ¨ Unity æ²¡æœ‰ Shader ç¼“å­˜æ—¶ï¼Œæå¤§æ¦‚ç‡ä¼šäº§å‡º"ä¸­é—´å˜ä½“"ã€‚è¿™äº›ä¸­é—´å˜ä½“ï¼ˆåŒ…æ‹¬ä¸€äº›ä¸å¯èƒ½å­˜åœ¨çš„å…³é”®å­—ç»„åˆï¼‰è¢«æ”¶é›†åˆ° SVC æ–‡ä»¶ä¸­ï¼Œå®é™…è¿è¡Œæ—¶é¢„çƒ­ä¼šå‡ºç° `shader variant not found` çš„æƒ…å†µã€‚
- **åŸå› **ï¼šå¼‚æ­¥ç¼–è¯‘æ—¶ï¼ŒUnity å¯èƒ½åœ¨ Shader å®Œå…¨ç¼–è¯‘å®Œæˆå‰å°±è®°å½•äº†ä¸´æ—¶çš„å˜ä½“çŠ¶æ€ã€‚
- **è§£å†³**ï¼š**å¼ºåˆ¶ä½¿ç”¨åŒæ­¥ç¼–è¯‘æ¨¡å¼**æ”¶é›†å˜ä½“ï¼š
    ```csharp
    EditorSettings.asyncShaderCompilation = false;
    ```
- **éªŒè¯**ï¼šåŒæ­¥ç¼–è¯‘æ¨¡å¼ä¸‹ï¼Œæ”¶é›†ç»“æœç¨³å®šä¸”å¯å¤ç°ã€‚

### 8.12 åŒæ­¥ç¼–è¯‘ä¸‹ multi_compile_local_fragment çš„å¼‚å¸¸è¡Œä¸º â­

- **é—®é¢˜**ï¼šåœ¨åŒæ­¥ç¼–è¯‘æ¨¡å¼ä¸‹ï¼Œå¦‚æœ Shader ä½¿ç”¨äº† `#pragma multi_compile_local_fragment` å½¢å¼ï¼š
    ```hlsl
    #pragma multi_compile_local_fragment _NOISEMODE_NONE _NOISEMODE_TRIPLANAR _NOISEMODE_NOISE3D _NOISEMODE_NOISE2D _NOISEMODE_NOISE2D_MAP
    ```
    ä¼šå¯¼è‡´å˜ä½“æ”¶é›†ä¸­å‡ºç°**æ²¡æœ‰ä»»ä½• `_NOISEMODE_XXX` å®**çš„ç»„åˆã€‚è¿™æ˜¾ç„¶ä¹Ÿä¼šå¯¼è‡´æœ€ç»ˆé¢„çƒ­æ—¶å‡ºç° `shader variant not found`ã€‚
- **åŸå› **ï¼šçŒœæµ‹æ˜¯ Unity åœ¨åŒæ­¥ç¼–è¯‘å’Œå¼‚æ­¥ç¼–è¯‘æ—¶å¯¹ `_fragment` åç¼€çš„å¤„ç†å­˜åœ¨å·®å¼‚ï¼Œä¹Ÿå¯èƒ½æ˜¯ Unity çš„ Bugã€‚
- **è§£å†³**ï¼š**å¿…é¡»ä½¿ç”¨ `multi_compile_local`**ï¼ˆä¸å¸¦ `_fragment` åç¼€ï¼‰ï¼š
    ```hlsl
    // âŒ é”™è¯¯ï¼šå¯èƒ½äº§ç”Ÿæ— å®å˜ä½“
    #pragma multi_compile_local_fragment _NOISEMODE_NONE _NOISEMODE_TRIPLANAR ...
    
    // âœ… æ­£ç¡®ï¼šå˜ä½“æ”¶é›†æ­£å¸¸
    #pragma multi_compile_local _NOISEMODE_NONE _NOISEMODE_TRIPLANAR ...
    ```
- **å½±å“**ï¼šå»æ‰ `_fragment` åç¼€ä¼šå¯¼è‡´é¡¶ç‚¹ç€è‰²å™¨ä¹ŸåŒ…å«è¿™äº›å˜ä½“ï¼Œå¯èƒ½ç•¥å¾®å¢åŠ å˜ä½“æ•°é‡ï¼Œä½†èƒ½ç¡®ä¿æ”¶é›†ç»“æœæ­£ç¡®ã€‚

### 8.13 åªä¿ç•™ VR å˜ä½“å¯¼è‡´ shader_feature_local å®ä¸¢å¤± â­

- **é—®é¢˜**ï¼šå¦‚æœ SVC æ–‡ä»¶ä¸­åªä¿ç•™ VR å˜ä½“ï¼Œä¼šå‡ºç°ä¸€ä¸ªå¥‡æ€ªçš„ç°è±¡ï¼š`shader_feature_local` æ‰€å£°æ˜çš„å®**å…¨éƒ¨ä¸¢å¤±**ï¼Œæ— è®ºæ˜¯å¦çœŸçš„è¢«ä½¿ç”¨ï¼›è€Œ `multi_compile_local` å£°æ˜çš„å®åˆ™æ­£å¸¸ä¿ç•™ã€‚
- **åŸå› **ï¼šæš‚ä¸æ˜ç¡®äº§ç”Ÿçš„åŸç†ï¼Œå¯èƒ½ä¸ Unity å¯¹ `shader_feature` çš„"æŒ‰éœ€ç¼–è¯‘"æœºåˆ¶æœ‰å…³ã€‚å½“ SVC ä¸­åªæœ‰ VR å˜ä½“æ—¶ï¼ŒUnity å¯èƒ½æ— æ³•æ­£ç¡®è¯†åˆ« `shader_feature` çš„ä½¿ç”¨æƒ…å†µã€‚
- **è§£å†³**ï¼šé‡‡ç”¨åŒæ–‡ä»¶ç­–ç•¥ï¼ŒNonVR SVC ä¸­ä¿ç•™å®Œæ•´çš„å˜ä½“ä¿¡æ¯ï¼Œç¡®ä¿ `shader_feature` å®ä¸ä¸¢å¤±ã€‚
- **å¤‡æ³¨**ï¼šæ­¤é—®é¢˜éœ€è¦è¿›ä¸€æ­¥ç ”ç©¶ Unity æºç æˆ–å®˜æ–¹æ–‡æ¡£ï¼Œå…ˆåšè®°å½•ã€‚

### 8.14 åŒæ–‡ä»¶ç­–ç•¥çš„åŒ…ä½“ä¸é¢„çƒ­æƒè¡¡ â­

- **é—®é¢˜**ï¼šå¦‚æœä¸ºäº†æŠŠå˜ä½“æ‰“å…¥ ABï¼Œå¿…é¡»æ”¶é›†é VR å˜ä½“ã€‚ä½†å¦‚æœ SVC æ–‡ä»¶ä¸­åŒæ—¶åŒ…å« VR å’Œé VR çš„å˜ä½“ï¼Œé¢„çƒ­æ—¶ä¼šåŒæ—¶é¢„çƒ­ä¸¤å¥—å˜ä½“ï¼Œ**ç›´æ¥çº¦ç­‰äºå¤šèŠ±ä¸€å€æ—¶é—´é¢„çƒ­**ã€‚
- **è§£å†³**ï¼šé‡‡ç”¨**åŒæ–‡ä»¶åˆ†ç¦»ç­–ç•¥**ï¼š
    | æ–‡ä»¶ | å†…å®¹ | ç”¨é€” |
    |------|------|------|
    | NonVR SVC | ä¸å« VR å…³é”®å­—çš„å˜ä½“ | æ‰“åŒ…æ—¶ä¿ç•™ Shaderï¼Œå…è®¸ VR å˜ä½“æ‰“å…¥ AB |
    | VR SVC | åªå« VR å…³é”®å­—çš„å˜ä½“ | è¿è¡Œæ—¶è°ƒç”¨é¢„çƒ­ï¼Œå‡å°‘é¢„çƒ­æˆæœ¬ |
- **å·¥ä½œåŸç†**ï¼š
    1. NonVR SVC ç¡®ä¿ç›¸å…³ Shader åœ¨æ‰“åŒ…æ—¶ä¸è¢«å‰”é™¤
    2. VR SVC è¢«æ‰“å…¥ AB åï¼Œè¿è¡Œæ—¶åªåŠ è½½ VR SVC è¿›è¡Œé¢„çƒ­
    3. å› ä¸º Shader æœ¬èº«å·²è¢«ä¿ç•™ï¼ŒVR å˜ä½“å¯ä»¥æ­£å¸¸ç¼–è¯‘ä½¿ç”¨
- **ä»£ä»·**ï¼šå› ä¸ºåŒæ—¶å¸¦æœ‰ VR å’Œé VR å˜ä½“ï¼Œä¼šå¯¼è‡´**åŒ…ä½“å¢å¤§**ï¼ˆå…·ä½“å¢é‡å–å†³äºé¡¹ç›®ä¸­ Shader çš„æ•°é‡å’Œå¤æ‚åº¦ï¼‰ã€‚
- **ä¼˜åŒ–æ–¹å‘**ï¼šå¦‚æœ‰å¿…è¦ï¼Œå¯é€šè¿‡ `IPreprocessShaders` æ¥å£åœ¨æ‰“åŒ…æ—¶å‰”é™¤é VR å˜ä½“ï¼Œè¿›ä¸€æ­¥å‡å°åŒ…ä½“ç©ºé—´ã€‚

---

## 9. å¸¸è§é—®é¢˜ FAQ

### Q: ä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä¸ª SVC æ–‡ä»¶ï¼Ÿ
A: NonVR æ–‡ä»¶ç”¨äºæ‰“åŒ…æ—¶ä¿ç•™ Shaderï¼ˆé˜²æ­¢è¢«å‰”é™¤ï¼‰ï¼ŒVR æ–‡ä»¶ç”¨äºè¿è¡Œæ—¶é¢„çƒ­ï¼ˆå‡å°‘é¢„çƒ­æ—¶é—´ï¼‰ã€‚è¯¦è§ 8.10 å’Œ 8.14ã€‚

### Q: æ”¶é›†æ—¶ Unity å´©æºƒäº†æ€ä¹ˆåŠï¼Ÿ
A: æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰ "fallback shader not found" è­¦å‘Šï¼Œå°†ç›¸å…³ Shader åŠ å…¥é»‘åå•ã€‚å·¥å…·å·²å†…ç½®å´©æºƒä¿æŠ¤æœºåˆ¶ã€‚

### Q: ç¨³å®šæ€§æµ‹è¯•ç»“æœä¸ä¸€è‡´ï¼Ÿ
A: ç¡®ä¿å¼€å¯"ç¯å¢ƒéš”ç¦»"å’Œ"é¢„çƒ­é˜¶æ®µ"ã€‚å¦‚æœä»ä¸ä¸€è‡´ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–ç¼–è¾‘å™¨çª—å£åœ¨åå°è¿è¡Œã€‚

### Q: ä¸ºä»€ä¹ˆé¢„çƒ­æ—¶è¿˜æ˜¯å‡ºç° shader variant not foundï¼Ÿ
A: å¯èƒ½åŸå› ï¼š
1. ä½¿ç”¨äº† `multi_compile_local_fragment`ï¼Œéœ€æ”¹ä¸º `multi_compile_local`ï¼ˆè§ 8.12ï¼‰
2. å¼‚æ­¥ç¼–è¯‘äº§ç”Ÿäº†ä¸­é—´å˜ä½“ï¼Œéœ€ç¡®ä¿ä½¿ç”¨åŒæ­¥ç¼–è¯‘æ¨¡å¼ï¼ˆè§ 8.11ï¼‰
3. SVC æ–‡ä»¶ä¸­åªæœ‰ VR å˜ä½“å¯¼è‡´æ‰“åŒ…å‰”é™¤ï¼ˆè§ 8.10ï¼‰

### Q: åŒ…ä½“å¢å¤§äº†æ€ä¹ˆåŠï¼Ÿ
A: åŒæ–‡ä»¶ç­–ç•¥ä¼šå¯¼è‡´åŒ…ä½“å¢å¤§ï¼Œå…·ä½“å¢é‡å–å†³äºé¡¹ç›® Shader æ•°é‡å’Œå¤æ‚åº¦ã€‚å¦‚éœ€ä¼˜åŒ–ï¼Œå¯å®ç° `IPreprocessShaders` æ¥å£åœ¨æ‰“åŒ…æ—¶å‰”é™¤é VR å˜ä½“ã€‚

